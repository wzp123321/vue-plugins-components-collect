<div class="node-parameter">
  <page-common title="节点参数配置" :showSearch="true">
    <template v-slot:pageSubTitle>
      <el-tooltip style="margin-left: 8px" effect="dark" placement="right">
        <template #content>
          <div style="white-space: normal; word-break: break-all">适用于具体能耗节点的参数，如手术室的湿度。</div>
        </template>
        <img
          class="question_mark"
          style="height: 16px"
          title="节点参数配置"
          src="../../../assets/img/common/common-question-mark.svg"
        />
      </el-tooltip>
    </template>
    <template v-slot:pageSearch>
      <!-- 头部 -->
      <div class="node-parameter--header flex-row-justify-center">
        <div class="node-parameter--header-form">
          <input
            v-inputFilter:search="{ allowSpace: false }"
            class="mr16"
            :maxlength="100"
            v-model.trim="queryParams.keyword"
            placeholder="请输入查询关键字"
          />
          <button primary @click="onSubmit">查询</button>
          <button @click="onReset">重置</button>
        </div>
        <button primary @click="onAddDialogShow">新增</button>
      </div>
    </template>
    <template v-slot:pageContent>
      <div style="height: 100%; width: 100%" v-loading="loading">
        <el-table :data="dataSource" style="width: 100%" v-show="!loading">
          <el-table-column prop="index" label="序号" width="80" align="center">
            <template #default="scope">
              {{ (queryParams.pageNum - 1) * queryParams.pageSize + scope.$index + 1 }}
            </template>
          </el-table-column>
          <el-table-column prop="name" label="参数名称" :show-overflow-tooltip="true"> </el-table-column>
          <el-table-column prop="typeName" label="参数类型" :show-overflow-tooltip="true"> </el-table-column>
          <el-table-column prop="unit" label="单位" :show-overflow-tooltip="true"> </el-table-column>
          <el-table-column label="时间颗粒度" :show-overflow-tooltip="true">
            <template #default="scope"> {{ resetTimeUnit(scope.row.timeTypes) }} </template>
          </el-table-column>
          <el-table-column label="关联节点" :show-overflow-tooltip="true">
            <template #default="scope"> {{ resetTreeNames(scope.row.treeMap) }} </template>
          </el-table-column>
          <el-table-column label="设备名称" :show-overflow-tooltip="true">
            <template #default="scope"> {{ scope.row.deviceName ?? '--' }} </template>
          </el-table-column>
          <el-table-column label="操作" width="200" align="left">
            <template #default="scope">
              <button text @click="onRelationNodeDialogShow(scope.row)">关联节点</button>
              <button text danger @click="onDeleteConfirm(scope.row.paramId, scope.row.paramType)">删除</button>
              <button
                text
                v-if="scope.row.paramType !== PARAM_TYPES.DEVICE_ACQUISITION 
                          && scope.row.paramType !== PARAM_TYPES.TIMETABLE "
                @click="onPageTo(scope.row.paramId, scope.row.paramType, scope.row.name, scope.row.timeTypes,
                              scope.row.standardPointCode, scope.row.treeMap)"
              >
                去配置
              </button>
            </template>
          </el-table-column>
        </el-table>
        <ems-pagination
          v-show="!loading && total>0"
          @size-change="onSizeChange"
          @current-change="onCurrentChange"
          :current-page="queryParams.pageNum"
          :page-sizes="pageSizes"
          :page-size="queryParams.pageSize"
          :total="total"
        >
        </ems-pagination>
      </div>
    </template>
  </page-common>
  <!-- 新增 编辑弹框 -->
  <div v-drag="dialogVisible">
    <el-dialog
      :close-on-click-modal="false"
      :title="isAddFlag ? '新增参数' : '编辑参数'"
      v-model="dialogVisible"
      :destroy-on-close="true"
      width="600px"
      :before-close="onbeforeClose"
    >
      <el-form
        class="node-parameter--form"
        :model="pageForm"
        :rules="rules"
        ref="form"
        label-position="right"
        :label-width="90"
        v-loading="formLoading"
        @submit.native.prevent
      >
        <el-form-item label="参数名称" prop="name">
          <el-input
            v-inputFilter:search="{ allowSpace: false }"
            v-model.trim="pageForm.name"
            autocomplete="off"
            placeholder="请输入参数名称"
            :maxlength="FORM_CHECK_RULES.NORMAL_INPUT_LENGTH"
          >
          </el-input>
        </el-form-item>
        <el-form-item label="单位" prop="unit">
          <el-input
            v-inputFilter:search="{ allowSpace: false }"
            v-model.trim="pageForm.unit"
            autocomplete="off"
            placeholder="请输入单位"
            :maxlength="FORM_CHECK_RULES.NORMAL_INPUT_LENGTH"
          >
          </el-input>
        </el-form-item>
        <el-form-item label="关联节点" prop="treeIds">
          <tree-select
            :placeholder="'请选择原节点'"
            v-model:modelValue="pageForm.treeIds"
            :loading="treeLoading"
            :treeData="treeList"
            :defaultProps="{ children: 'childTree', label: 'treeName' }"
            :showSearch="true"
            v-model:radioValue="treeType"
            :radioData="treeTypeList"
            :expanedKeys="treeExpandKeys"
            :defaultExpandAll="false"
            :multiple="true"
            :autoWidth="true"
            @tree-radio-change="onTreeTypeChange"
            @select-change="onTreeSelect"
          ></tree-select>
        </el-form-item>
        <el-form-item label="参数类型" prop="paramType">
          <el-cascader
            placeholder="请选择参数类型"
            :disabled="pageForm.id !== -1"
            :options="parameterTypeList"
            :show-all-levels="false"
            v-model="pageForm.paramType"
            @change="onCascaderChange"
          ></el-cascader>
        </el-form-item>
        <el-form-item
          label="能源名称:"
          v-if="pageForm.paramType[pageForm.paramType.length - 1] == PARAM_TYPES.DEVICE_ACQUISITION"
          prop="energyCode"
        >
          <el-select
            v-model="pageForm.energyCode"
            :disabled="pageForm.id !== -1"
            placeholder="请选择能源名称"
            v-if="pageForm.paramType.length> 0 && pageForm.paramType[pageForm.paramType.length - 1] == PARAM_TYPES.DEVICE_ACQUISITION"
            @change="onEnergyCodeChange"
          >
            <el-option
              v-for="item in energyCodeList"
              :key="item.code"
              :label="item.name"
              :value="item.code"
            ></el-option>
          </el-select>
          <el-input v-else disabled v-model="pageForm.standardPointName"></el-input>
        </el-form-item>
        <el-form-item
          label="关联设备:"
          v-if="pageForm.paramType.length > 0 && pageForm.paramType[pageForm.paramType.length - 1] == PARAM_TYPES.DEVICE_ACQUISITION"
          prop="deviceId"
        >
          <el-select
            v-model="pageForm.deviceId"
            v-if="pageForm.paramType && pageForm.paramType.length"
            :clearable="true"
          >
            <el-option
              v-for="item in deviceList"
              :key="item.deviceId+'_'+ item.pointNumber"
              :label="item.deviceName"
              :value="item.deviceId+'_'+ item.pointNumber"
            ></el-option>
          </el-select>
          <el-input disabled v-model="pageForm.standardPointName" v-else></el-input>
        </el-form-item>
        <el-form-item label="时间颗粒度" prop="timeTypes">
          <el-select v-model="pageForm.timeTypes" multiple placeholder="请选择时间颗粒度">
            <el-option
              v-for="(item, index) in timeUnits"
              :key="'time_'+ index"
              :label="item.label"
              :value="item.value"
              :disabled="disabledList[index]"
            ></el-option>
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="onbeforeClose">取消</el-button>
        <el-button type="primary" @click="onAddUpdateDialogSubmit" :loading="reqLoading">确定</el-button>
      </template>
    </el-dialog>
  </div>
</div>
